generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "windows"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  VIEWER
}

model AdminUser {
  id           Int      @id @default(autoincrement())
  email        String   @unique
  passwordHash String
  name         String?
  role         UserRole @default(ADMIN)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Setting {
  id                       Int      @id @default(1)
  defaultBeltMarkupRupees  Decimal  @default(20)
  defaultLowStockThreshold Int      @default(10)
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt
}

model Item {
  id                    Int                  @id @default(autoincrement())
  sku                   String               @unique
  name                  String
  brandNumber           String?
  brand                 String?
  productType           String?
  sizeCode              String?
  packType              String?
  unitsPerPack          Int?
  packSizeLabel         String?
  category              String?
  volumeMl              Int?
  mrpPrice              Decimal
  purchaseCostPrice     Decimal?             // Latest purchase cost (for reference)
  weightedAvgCostPrice  Decimal?             // Weighted average cost WITHOUT tax/misc (for gross profit)
  weightedAvgTotalCostPrice Decimal?         // Weighted average cost WITH tax/misc (for net profit)
  totalInventoryValue   Decimal?             // Total value of current inventory WITHOUT tax/misc
  totalInventoryValueWithCharges Decimal?     // Total value of current inventory WITH tax/misc
  currentStockUnits     Int                  @default(0)
  reorderLevel          Int?
  isActive              Boolean              @default(true)
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  purchases             PurchaseLineItem[]
  salesLines            DayEndReportLine[]
  adjustments           StockAdjustment[]

  @@index([brandNumber])
  @@index([brandNumber, sizeCode])
}

model Purchase {
  id                   Int                @id @default(autoincrement())
  purchaseDate         DateTime
  supplierName         String?
  notes                String?
  taxAmount            Decimal?           @default(0)
  miscellaneousCharges Decimal?           @default(0)
  createdAt            DateTime           @default(now())
  lineItems            PurchaseLineItem[]
}

model PurchaseLineItem {
  id                 Int       @id @default(autoincrement())
  purchase           Purchase  @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  purchaseId         Int
  item               Item      @relation(fields: [itemId], references: [id])
  itemId             Int
  quantityUnits      Int
  casesQuantity      Int?
  unitsPerCase       Int?
  packType           String?
  packSizeLabel      String?
  brandNumber        String?
  productType        String?
  sizeCode           String?
  unitCostPrice      Decimal                 // Base unit cost (without tax/misc)
  unitTotalCostPrice Decimal?                // Unit cost WITH allocated tax/misc
  caseCostPrice      Decimal?
  lineTotalPrice     Decimal?                // Line total (base cost only)
  lineTotalCostWithCharges Decimal?          // Line total WITH allocated tax/misc
  allocatedTaxAmount Decimal?                // Tax allocated to this line item
  allocatedMiscCharges Decimal?              // Misc charges allocated to this line item
  mrpPriceAtPurchase Decimal?
  createdAt          DateTime  @default(now())
}

model DayEndReport {
  id               Int                 @id @default(autoincrement())
  reportDate       DateTime            @unique
  beltMarkupRupees Decimal             @default(20)
  totalSalesAmount Decimal?
  totalUnitsSold   Int?
  retailRevenue    Decimal?
  beltRevenue      Decimal?
  totalCost        Decimal?                 // Total cost WITHOUT tax/misc (gross cost)
  totalCostWithCharges Decimal?              // Total cost WITH tax/misc (net cost)
  totalProfit      Decimal?                 // Gross profit (revenue - base cost)
  totalNetProfit   Decimal?                 // Net profit (revenue - total cost with charges)
  notes            String?
  createdAt        DateTime            @default(now())
  lines            DayEndReportLine[]
}

model DayEndReportLine {
  id                    Int          @id @default(autoincrement())
  report                DayEndReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  reportId              Int
  item                  Item         @relation(fields: [itemId], references: [id])
  itemId                Int
  channel               String
  quantitySoldUnits     Int
  mrpPrice              Decimal
  sellingPricePerUnit   Decimal
  lineRevenue           Decimal
  costPriceAtSale       Decimal?             // Base cost per unit (without tax/misc)
  costPriceAtSaleWithCharges Decimal?        // Total cost per unit (with tax/misc)
  lineCost              Decimal?             // Line cost WITHOUT tax/misc (gross cost)
  lineCostWithCharges   Decimal?             // Line cost WITH tax/misc (net cost)
  lineProfit            Decimal?             // Gross profit (revenue - base cost)
  lineNetProfit         Decimal?             // Net profit (revenue - total cost with charges)
  createdAt             DateTime     @default(now())

  @@index([reportId])
  @@index([itemId])
}

model StockAdjustment {
  id              Int      @id @default(autoincrement())
  item            Item     @relation(fields: [itemId], references: [id])
  itemId          Int
  adjustmentUnits Int
  reason          String?
  createdBy       String?
  createdAt       DateTime @default(now())
}
